# Governance Agent Protocol

**Version:** 1.0.0
**Last Updated:** 2026-01-29

This document defines the protocol for NXTG-Forge agents to interact with the Governance System.

---

## Table of Contents

1. [Overview](#overview)
2. [When to Report](#when-to-report)
3. [Sentinel Log Entry Format](#sentinel-log-entry-format)
4. [Severity Levels](#severity-levels)
5. [Event Categories](#event-categories)
6. [Code Examples](#code-examples)
7. [Best Practices](#best-practices)
8. [API Endpoints](#api-endpoints)

---

## Overview

The Governance System provides real-time oversight of agent orchestration, risk assessment, and strategic alignment. Agents report events through **Sentinel Logs** that appear in the Governance HUD.

**Core Principles:**
- **Signal, Don't Noise**: Only report meaningful events
- **Structured Data**: Use standard schema for consistency
- **High Confidence**: Report when you're 80%+ confident
- **Actionable**: Include context for decision-making

---

## When to Report

### ✅ **Report These Events:**

1. **Scope Violations**
   - Agent modifies files outside stated directive
   - Example: UI task touches database schema

2. **Architecture Drift**
   - Implementation diverges from design principles
   - Example: Tight coupling in micro-services architecture

3. **Governance Violations**
   - Breaking defined rules or policies
   - Example: Using banned library (jQuery)

4. **Risk Changes**
   - Workstream risk level changes
   - Example: Critical blocker detected

5. **Major Milestones**
   - Significant progress achieved
   - Example: "Authentication system complete, 12/12 tasks done"

6. **Critical Errors**
   - Unrecoverable failures that need human intervention
   - Example: "Database migration failed, manual rollback required"

### ❌ **Don't Report These:**

1. **Routine Operations** - File writes, successful tests, normal completion
2. **Low-Confidence Hunches** - Only report when >80% confident
3. **Duplicate Events** - Check if similar event already logged
4. **Trivial Warnings** - Lint errors, minor style issues

---

## Sentinel Log Entry Format

### Required Fields

```typescript
interface SentinelEntry {
  // Auto-generated by system (don't provide)
  id?: string;              // Auto: "sentinel-{timestamp}-{random}"
  timestamp?: number;       // Auto: Date.now()

  // Required fields (you must provide)
  type: 'INFO' | 'WARN' | 'ERROR' | 'CRITICAL' | 'SUCCESS';
  severity: 'low' | 'medium' | 'high' | 'critical';
  source: string;           // Your agent name (e.g., "forge-oracle", "forge-builder")
  message: string;          // Clear, actionable message (1-2 sentences)

  // Optional but recommended
  category?: 'scope' | 'drift' | 'governance' | 'risk' | 'milestone';
  context?: {               // Additional structured data
    files?: string[];       // Affected files
    workstream?: string;    // Related workstream ID
    violations?: string[];  // Rule violations
    suggestion?: string;    // Recommended action
    [key: string]: any;     // Custom context
  };
  actionRequired?: boolean; // Does this need human intervention?
}
```

### Field Descriptions

- **`type`**: Event classification (what happened)
- **`severity`**: Importance level (how critical)
- **`source`**: Which agent reported this
- **`message`**: Human-readable summary
- **`category`**: Governance category for filtering
- **`context`**: Machine-readable details
- **`actionRequired`**: Flag for urgent items

---

## Severity Levels

| Severity | When to Use | Auto-Dismiss | User Action |
|----------|-------------|--------------|-------------|
| **low** | Informational updates, minor observations | ✅ Yes (7 days) | None required |
| **medium** | Warnings that should be reviewed | ✅ Yes (7 days) | Review recommended |
| **high** | Significant issues requiring attention | ⚠️ Conditional | Action recommended |
| **critical** | Never auto-dismissed, persisted permanently | ❌ Never | Immediate action |

**Severity Guidelines:**
- **low**: "Database schema updated", "Tests passing"
- **medium**: "Test coverage dropped 5%", "Minor scope expansion"
- **high**: "Architecture drift detected", "Blocked workstream"
- **critical**: "Build broken", "Security vulnerability", "Data loss risk"

---

## Event Categories

### 1. **Scope** (`category: 'scope'`)
Changes outside defined boundaries.

**Examples:**
- "UI task modifying database schema"
- "Auth implementation touching billing module"

### 2. **Drift** (`category: 'drift'`)
Implementation diverging from design.

**Examples:**
- "Tight coupling in microservices"
- "Violating single responsibility principle"

### 3. **Governance** (`category: 'governance'`)
Policy or rule violations.

**Examples:**
- "Using banned library (jQuery)"
- "Missing security headers in API"

### 4. **Risk** (`category: 'risk'`)
Risk level changes.

**Examples:**
- "Workstream risk elevated to HIGH"
- "Critical blocker detected"

### 5. **Milestone** (`category: 'milestone'`)
Significant achievements.

**Examples:**
- "Authentication system complete"
- "All quality gates passed"

---

## Code Examples

### Example 1: Scope Violation (TypeScript)

```typescript
// forge-oracle detecting scope violation
const sentinelEntry = {
  type: 'WARN' as const,
  severity: 'medium' as const,
  category: 'scope' as const,
  source: 'forge-oracle',
  message: 'Scope expansion: Database schema modified during UI refactoring task',
  context: {
    files: ['src/database/schema.sql', 'src/database/migrations/001.sql'],
    workstream: 'gov-001',
    violations: ['scope_creep'],
    suggestion: 'Consider creating separate database migration workstream'
  },
  actionRequired: false
};

await fetch('/api/governance/sentinel', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(sentinelEntry)
});
```

### Example 2: Critical Error (Python)

```python
# forge-builder reporting critical failure
import requests
import time

sentinel_entry = {
    "type": "CRITICAL",
    "severity": "critical",
    "category": "risk",
    "source": "forge-builder",
    "message": "Build failed with unrecoverable errors. Manual intervention required.",
    "context": {
        "files": ["src/core/orchestrator.ts"],
        "workstream": "gov-001",
        "error_code": "TS2345",
        "suggestion": "Rollback to previous commit (9fa4eed)"
    },
    "actionRequired": True
}

response = requests.post(
    'http://localhost:5051/api/governance/sentinel',
    json=sentinel_entry
)
```

### Example 3: Milestone Achievement (Bash)

```bash
# Agent reporting completion
curl -X POST http://localhost:5051/api/governance/sentinel \
  -H "Content-Type: application/json" \
  -d '{
    "type": "SUCCESS",
    "severity": "low",
    "category": "milestone",
    "source": "forge-builder",
    "message": "Governance HUD implementation complete: 11/11 tasks done",
    "context": {
      "workstream": "gov-001",
      "progress": 100,
      "testsRun": 47,
      "testsPassed": 47
    },
    "actionRequired": false
  }'
```

---

## Best Practices

### 1. **Be Specific in Messages**

❌ Bad: "Error occurred"
✅ Good: "Database migration failed: duplicate column name 'user_id'"

❌ Bad: "Something wrong with auth"
✅ Good: "Authentication token validation failing for expired JWT tokens"

### 2. **Include Actionable Context**

```typescript
// ❌ Minimal context
{
  message: "File modified",
  context: { files: ["foo.ts"] }
}

// ✅ Actionable context
{
  message: "Critical file modified outside scope",
  context: {
    files: ["src/core/authentication.ts"],
    workstream: "gov-001",
    directive: "Implement UI components",
    suggestion: "Move auth changes to separate workstream or update directive"
  }
}
```

### 3. **Use Appropriate Severity**

**Severity Ladder:**
1. **low**: Informational, no action needed
2. **medium**: Review recommended, not urgent
3. **high**: Action should be taken soon
4. **critical**: Immediate attention required

**Ask yourself:** "If I ignore this, what breaks?"
- Nothing breaks → **low**
- Minor issues later → **medium**
- Major issues soon → **high**
- System fails now → **critical**

### 4. **Check for Duplicates**

Before reporting, check if similar event already exists:

```typescript
// Read current state first
const response = await fetch('/api/governance/state');
const { data: state } = await response.json();

// Check recent logs
const recentLogs = state.sentinelLog.slice(-10);
const isDuplicate = recentLogs.some(log =>
  log.message === myMessage &&
  Date.now() - log.timestamp < 60000 // Within 1 minute
);

if (!isDuplicate) {
  // Report new event
}
```

### 5. **Confidence Threshold**

Only report when you're 80%+ confident:

```typescript
const confidence = calculateConfidence(analysis);

if (confidence >= 0.8) {
  // Report with high confidence
  await reportSentinelLog({
    type: 'WARN',
    message: `Scope violation detected (${Math.round(confidence * 100)}% confidence)`,
    // ...
  });
}
```

---

## API Endpoints

### POST `/api/governance/sentinel`
Add new sentinel log entry with automatic rotation.

**Request:**
```json
{
  "type": "WARN",
  "severity": "medium",
  "source": "forge-oracle",
  "message": "Scope expansion detected",
  "category": "scope",
  "context": {
    "files": ["src/database/schema.sql"],
    "workstream": "gov-001"
  },
  "actionRequired": false
}
```

**Response:**
```json
{
  "success": true,
  "message": "Sentinel log entry added",
  "timestamp": "2026-01-29T12:00:00.000Z"
}
```

### GET `/api/governance/state`
Retrieve current governance state.

**Response:**
```json
{
  "success": true,
  "data": {
    "version": 1,
    "timestamp": "2026-01-29T12:00:00.000Z",
    "constitution": { /* ... */ },
    "workstreams": [ /* ... */ ],
    "sentinelLog": [ /* ... */ ],
    "metadata": { /* ... */ }
  },
  "timestamp": "2026-01-29T12:00:00.000Z"
}
```

### GET `/api/governance/config`
Retrieve governance configuration.

**Response:**
```json
{
  "success": true,
  "data": {
    "thresholds": {
      "criticalErrorLimit": 3,
      "minConfidence": 50,
      /* ... */
    },
    "sentinelLog": {
      "maxEntries": 1000,
      "retentionDays": 7,
      /* ... */
    }
  }
}
```

---

## Quick Reference Card

```
┌─────────────────────────────────────────────────────┐
│ AGENT PROTOCOL QUICK REFERENCE                      │
├─────────────────────────────────────────────────────┤
│                                                      │
│ WHEN TO REPORT:                                      │
│  ✓ Scope violations (file outside directive)        │
│  ✓ Architecture drift (violates design)             │
│  ✓ Governance violations (breaks rules)             │
│  ✓ Risk changes (blocker/unblocked)                 │
│  ✓ Milestones (major completion)                    │
│  ✓ Critical errors (needs human)                    │
│                                                      │
│ SEVERITY:                                            │
│  • low      → Informational                          │
│  • medium   → Review recommended                     │
│  • high     → Action needed                          │
│  • critical → URGENT (never deleted)                 │
│                                                      │
│ REQUIRED FIELDS:                                     │
│  • type: WARN|ERROR|INFO|CRITICAL|SUCCESS            │
│  • severity: low|medium|high|critical                │
│  • source: "your-agent-name"                         │
│  • message: "Clear action statement"                 │
│                                                      │
│ API:                                                 │
│  POST /api/governance/sentinel                       │
│  { type, severity, source, message, context }        │
│                                                      │
└─────────────────────────────────────────────────────┘
```

---

## Revision History

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2026-01-29 | Initial protocol specification |

---

**Questions?** See the [Governance HUD Documentation](../docs/governance-hud.md) or [GitHub Issues](https://github.com/nxtg-ai/forge/issues).
